<!DOCTYPE html>
<html>
<head>
    <title>Google Maps Example</title>
    <style>
        /* Specify the dimensions of the map container */
        #map {
            height: 400vw; /* Adjust the height as needed */
            width: 100%;   /* Adjust the width as needed */
        }

    body{
        background-color: #E6E5D3;
    }
    .info-card {
        display: flex;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        background-color: #fff;
        max-width: 400px; /* Set a fixed maximum width for the card */
    }

 
    .info-image {
        width: 100px; 
        height: 100px; 
        object-fit: cover; 
        margin-right: 10px;
    }
    .info-title {
        font-size: 18px;
        font-weight: bold;
        text-decoration: none;
        color: #007BFF;
    }

    .info-cuisine {
        font-size: 14px;
        color: #555;
    }

    .info-address {
        font-size: 14px;
        color: #555;
    }

    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        function initMap() {
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15, // Adjust the zoom level as needed
            });

            // Sample geolocation array, should replace with a database record [implementing]
            var geolocationArray = [];

            axios.get("http://127.0.0.1:5000/api/restaurants")
            .then((response) => {
                restaurants = response.data;
                for (let i = 0; i < restaurants.length; i++) {
                    var lat  = restaurants[i].Latitude;
                    var lng = restaurants[i].Longitude;
                    var title = restaurants[i].Name;
                    var res_image = restaurants[i].Image;
                    var cuisine = restaurants[i].Cuisine_Foodtype;
                    var page = restaurants[i].page_link;
                    var address = restaurants[i].Location;
                    var postal = restaurants[i].Postal_Code;
                    var ratings = restaurants[i].Ratings;
                    var price = restaurants[i].Price;
                    geolocationArray.push({lat, lng, title, res_image, cuisine, page, address, postal, ratings, price});
                }

                console.log(geolocationArray);

                var infowindow = new google.maps.InfoWindow();

                geolocationArray.forEach(function(location) {
                    var marker = new google.maps.Marker({
                        position: location,
                        map: map,
                        title: location.title,
                        icon: {
                            url:'earth.png',
                            scaledSize: new google.maps.Size(30, 30),
                            
                        }
                    });

                    var remove_cuisine = location.cuisine.replace(/\[|\]/g, '');
                    //Get the star ratings 
                    
                    //Star image
                    var StarStr = "<img src='./star.png' width='15px' height='15px' >";
                    //repeat based on the rating number 
                    var reviewNumber = Math.floor(location.ratings)
                    // console.log(reviewNumber)
                    var repeatStar = StarStr.repeat(reviewNumber)
                    // Set the content of the info window
                    var content = `
                    <div class="info-card">
                        <img src="${location.res_image}" alt="${location.title}" class="info-image">
                        <div class="info-details">
                            <a href="${location.page}" target="_blank" class="info-title">${location.title}</a>
                            <p class="info-price">Price: ${location.price}</p>
                            <p class="info-ratings">Rating: ${location.ratings} ${repeatStar}</p>
                            <p class="info-cuisine">Food Type: ${remove_cuisine}</p>
                            <p class="info-address">Address: ${location.address} Singapore ${location.postal}</p>
                        </div>
                    </div>
                    `;

                    // Add a click event listener to show the info window when the marker is clicked
                    marker.addListener('click', function() {
                        // Close any previously opened info windows
                        infowindow.close();
                        
                        // Set the content and open the info window for the clicked marker
                        infowindow.setContent(content);
                        infowindow.open(map, marker);
                    });
                });

                // Use the Geolocation API to get the user's current location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var userLatLng = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        map.setCenter(userLatLng);

                        var blueMarker = new google.maps.Marker({
                            position: userLatLng,
                            map: map,
                            title: 'Your Location',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE, // Use a circle symbol
                                scale: 8, // Adjust the size of the dot
                                fillColor: 'red', // Set the fill color (blue)
                                fillOpacity: 1, // Set the fill opacity (fully opaque)
                                strokeWeight: 1,
                                strokeColor: 'white'
                            }
                        });
                    }, function() {
                        // Handle geolocation error
                        console.error('Error: The Geolocation service failed.');
                    });
                } else {
                    // Browser doesn't support Geolocation
                    console.error();
                }
                

            }).catch((error) => {
                console.log(error);
            });
        }
                
        //update user's marker position while user make movement
        var userMarker;

        function updateUserMarker(position) {
            var userLatLng = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            if (!userMarker) {
                userMarker = new google.maps.Marker({
                    position: userLatLng,
                    map: map,
                    title: 'Your Location',
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE, // Use a circle symbol
                        scale: 8, // Adjust the size of the dot
                        fillColor: 'red', // Set the fill color (blue)
                        fillOpacity: 1, // Set the fill opacity (fully opaque)
                        strokeWeight: 1,
                        strokeColor: 'white'
                    }
                });
            } else {
                userMarker.setPosition(userLatLng);
            }
            map.setCenter(userLatLng);
        }

        // Use the Geolocation API to watch the user's position and update the marker
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(updateUserMarker, function() {
                // Handle geolocation error
                console.error('Error: The Geolocation service failed.');
            });
        } else {
            // Browser doesn't support Geolocation
            console.error('Error: Geolocation is not supported by this browser.');
        }
    </script>

    <!-- Load the Google Maps JavaScript API with your API key -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCioe4QDxeWFp_YOBDT9bqVeMfBY_3clTo&callback=initMap">
    </script>
</body>
</html>