<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="keywords" content="HTML, CSS, JavaScript">
    <meta name="description" content="Web Application for Ecobites">
    <meta name="author" content="May Myat Noe Aung">
    <!-- Link main CSS -->
    <link rel="stylesheet" href="../static/css/main.css">
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <title>Find Nearby Restaurants</title>
    <style>
        /* Specify the dimensions of the map container */

        #map {
           /* Adjust the width as needed */
            height: 100vh;
            width: 100%;
        }

        body{
            background-color: #e6e5d3;
        }
        .info-card {
            display: flex;
            border: 1px solid #0a0c0b;
            border-radius: 5px;
            padding: 10px;
            background-color: #f8ffdd;
            max-width: 400px; /* Set a fixed maximum width for the card */
        }

    
        .info-image {
            width: 100px; 
            height: 100px; 
            object-fit: cover; 
            margin-right: 10px;
        }
        .info-title {
            font-size: 18px;
            font-weight: bold;
            text-decoration: none;
            color: #154630;
        }

        .info-cuisine {
            font-size: 14px;
            color: black;
        }

        .info-address {
            font-size: 14px;
            color: black;
        }

        .info-price{
            color: black;
        }

        .bold{
            color: black;
            font-weight: bold;
        }


    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light" id="navigationBar">
        <a class="navbar-brand d-flex align-items-center" href="../templates/index.html">
            <img src="../static/images/icon.PNG" class="mr-2" id="Logo" alt="Logo">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto nav">
                <li class="nav-item active mx-4">
                    <a class="nav-link" href="../templates/index.html" >Home</a>
                </li>
                <li class="nav-item active mx-4">
                    <a class="nav-link" href="../restaurants_filter/rest_filter.html" >Restaurant Filter</a>
                </li>
                <li class="nav-item active mx-4">
                    <a class="nav-link active" href="../map/mapPointer2.html" >Restaurant Nearby</a>
                </li>
                <li class="nav-item active mx-4">
                    <a class="nav-link" href="../templates/contact.html">Contact Us</a>
                </li>
            </ul>
        </div>
        <div class="icons-container">
            <a href="../saved_fav_restaurant/fav_rest_ver2.html" class="bi bi-heart" style="font-size: 20px;"></a>
            <a href="../Landing_page/landing_page.html" class="bi bi-box-arrow-right" style="font-size: 20px;"></a>
        </div>
    </nav>
    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
    function getStarRatingHtml(rating) {
        var fullStars = Math.floor(rating);
        var hasHalfStar = rating % 1 !== 0; 
        var starHtml = '';

        for (var i = 0; i < fullStars; i++) {
            starHtml += '<img src="./star.png" width="15px" height="15px">';
        }

        if (hasHalfStar) {
            starHtml += '<img src="./half-star.png" width="15px" height="15px">';
        }

        var totalStars = 5;
        var displayedStars = fullStars + (hasHalfStar ? 0.5 : 0);
        var remainingStars = totalStars - displayedStars;

        for (var i = 1; i <= remainingStars; i++) {
            starHtml += '<img src="./grey-star.png" width="15px" height="15px">';
        }

        return starHtml;
}

        

        function initMap() {
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15, // Adjust the zoom level as needed
            });

            // Sample geolocation array, should replace with a database record [implementing]
            var geolocationArray = [];

            axios.get("http://127.0.0.1:5000/api/restaurants")
            .then((response) => {
                restaurants = response.data;
                for (let i = 0; i < restaurants.length; i++) {
                    var lat  = restaurants[i].Latitude;
                    var lng = restaurants[i].Longitude;
                    var title = restaurants[i].Name;
                    var res_image = restaurants[i].Image;
                    var cuisine = restaurants[i].Cuisine_Foodtype;
                    var page = restaurants[i].page_link;
                    var address = restaurants[i].Location;
                    var postal = restaurants[i].Postal_Code;
                    var ratings = restaurants[i].Ratings;
                    var price = restaurants[i].Price;
                    geolocationArray.push({lat, lng, title, res_image, cuisine, page, address, postal, ratings, price});
                }

                console.log(geolocationArray);

                var infowindow = new google.maps.InfoWindow();

                geolocationArray.forEach(function(location) {
                    var marker = new google.maps.Marker({
                        position: location,
                        map: map,
                        title: location.title,
                        icon: {
                            url:'updatedPoint.png',
                            // size: new google.maps.Size(90, 90),
                            scaledSize: new google.maps.Size(43, 43),
                            
                            
                        }
                    });

                    var remove_cuisine = location.cuisine.replace(/\[|\]/g, '');
                    //Get the star ratings 
                    var repeatStar = getStarRatingHtml(location.ratings);
                    // Set the content of the info window
                    var content = `
                    <div class="info-card">
                        <img src="${location.res_image}" alt="${location.title}" class="info-image">
                        <div class="info-details">
                            <p><a href="${location.page}" target="_blank" class="info-title">${location.title} </a></p>
                      
                            <p class="info-ratings"><span class="bold">Rating:${repeatStar}</span></p>
                            <p class="info-price"><span class="bold">Price:</span> ${location.price}</p>
                            <p class="info-cuisine"><span class="bold">Food Type:</span> ${remove_cuisine}</p>
                            <p class="info-address"><span class="bold">Address: </span>${location.address} Singapore ${location.postal}</p>
                        </div>
                    </div>
                    `

                    // Add a click event listener to show the info window when the marker is clicked
                    marker.addListener('click', function() {
                        // Close any previously opened info windows
                        infowindow.close();
                        
                        // Set the content and open the info window for the clicked marker
                        infowindow.setContent(content);
                        infowindow.open(map, marker);
                    });
                });

                // Use the Geolocation API to get the user's current location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var userLatLng = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        map.setCenter(userLatLng);

                        var blueMarker = new google.maps.Marker({
                            position: userLatLng,
                            map: map,
                            title: 'Your Location',
                            icon: {
                                url:'location2.png',
                                scaledSize: new google.maps.Size(100, 100)
                                // path: google.maps.SymbolPath.CIRCLE, // Use a circle symbol
                                // scale: 8, // Adjust the size of the dot
                                // fillColor: 'red', // Set the fill color (blue)
                                // fillOpacity: 1, // Set the fill opacity (fully opaque)
                                // strokeWeight: 1,
                                // strokeColor: 'white'
                            }
                        });
                    }, function() {
                        // Handle geolocation error
                        console.error('Error: The Geolocation service failed.');
                    });
                } else {
                    // Browser doesn't support Geolocation
                    console.error();
                }
                

            }).catch((error) => {
                console.log(error);
            });
        }
                
        //update user's marker position while user make movement
        var userMarker;

        function updateUserMarker(position) {
            var userLatLng = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            if (!userMarker) {
                userMarker = new google.maps.Marker({
                    position: userLatLng,
                    map: map,
                    title: 'Your Location',
                    icon: {
                        url:'placeholder.png',
                        scaledSize: new google.maps.Size(43, 43),
                        // path: google.maps.SymbolPath.CIRCLE, // Use a circle symbol
                        // scale: 8, // Adjust the size of the dot
                        // fillColor: 'red', // Set the fill color (blue)
                        // fillOpacity: 1, // Set the fill opacity (fully opaque)
                        // strokeWeight: 1,
                        // strokeColor: 'white'
                    }
                });
            } else {
                userMarker.setPosition(userLatLng);
            }
            map.setCenter(userLatLng);
        }

        // Use the Geolocation API to watch the user's position and update the marker
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(updateUserMarker, function() {
                // Handle geolocation error
                console.error('Error: The Geolocation service failed.');
            });
        } else {
            // Browser doesn't support Geolocation
            console.error('Error: Geolocation is not supported by this browser.');
        }
    </script>

    <!-- Load the Google Maps JavaScript API with your API key -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB-T9te52AnjFsOMZFIj3fZn90moHFfrM0&callback=initMap">
    </script>
</body>
</html>